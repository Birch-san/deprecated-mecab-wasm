<!doctype html>
<html lang="en-us">
<head>
    <!--
    Copied from https://webassembly.github.io/demo/AngryBots/
  -->
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Unity WebGL Player | AngryBots</title>
  <!-- <link rel="stylesheet" href="TemplateData/style.css"> -->
  <!-- <link rel="shortcut icon" href="TemplateData/favicon.ico" /> -->
  <script src="UnityProgress.js"></script>
</head>
<body class="template" scroll="no" style="overflow: hidden; margin: 0px; background-color: black;">
<!--    <p class="header"><span>Unity WebGL Player | </span>AngryBots</p>
  <div class="template-wrap clear"> -->
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="600px" width="938px"></canvas>
  <!--
      <div class="logo"></div>
      <div class="fullscreen"><img src="TemplateData/fullscreen.png" width="38" height="38" alt="Fullscreen" title="Fullscreen" onclick="SetFullscreen(1);" /></div>
      <div class="title">AngryBots</div>
    </div>
    <p class="footer">&laquo; created with <a href="http://unity3d.com/" title="Go to unity3d.com">Unity</a> &raquo;</p>
  -->

  <script type='text/javascript'>



    function softFullscreenResizeWebGLRenderTarget() {
      var inHiDPIFullscreenMode = true;
      var inAspectRatioFixedFullscreenMode = false;
      var inPixelPerfectFullscreenMode = true;
      var inCenteredWithoutScalingFullscreenMode = false;
      var screenWidth = inHiDPIFullscreenMode ? Math.round(window.innerWidth*window.devicePixelRatio) : window.innerWidth;
      var screenHeight = inHiDPIFullscreenMode ? Math.round(window.innerHeight*window.devicePixelRatio) : window.innerHeight;
//  var screenWidth = screen.width * window.devicePixelRatio;
//  var screenHeight = screen.height * window.devicePixelRatio;
var w = screenWidth;
var h = screenHeight;
var canvas = Module['canvas'];
var x = canvas.width;
var y = canvas.height;
var topMargin;

if (inAspectRatioFixedFullscreenMode) {
  if (w*y < x*h) h = (w * y / x) | 0;
  else if (w*y > x*h) w = (h * x / y) | 0;
  topMargin = ((screenHeight - h) / 2) | 0;
}

if (inPixelPerfectFullscreenMode) {
  canvas.width = w;
  canvas.height = h;
  console.log('new canvas size: ' + w + 'x' + h);
  if (canvas.GLctxObject) canvas.GLctxObject.GLctx.viewport(0, 0, canvas.width, canvas.height);
}

  // Back to CSS pixels.
  if (inHiDPIFullscreenMode) {
    topMargin /= window.devicePixelRatio;
    w /= window.devicePixelRatio;
    h /= window.devicePixelRatio;
    // Round to nearest 4 digits of precision.
    w = Math.round(w*1e4)/1e4;
    h = Math.round(h*1e4)/1e4;
    topMargin = Math.round(topMargin*1e4)/1e4;
  }
/*
  if (inCenteredWithoutScalingFullscreenMode) {
    var t = (window.innerHeight - parseInt(canvas.style.height)) / 2;
    var b = (window.innerWidth - parseInt(canvas.style.width)) / 2;
    __setLetterbox(canvas, t, b);
  } else {
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    var b = (window.innerWidth - w) / 2;
    __setLetterbox(canvas, topMargin, b);
  }
  */  
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
}

document.getElementById('canvas').style.width = window.innerWidth + 'px';
document.getElementById('canvas').style.height = window.innerHeight + 'px';
document.getElementById('canvas').width = window.innerWidth * window.devicePixelRatio;
document.getElementById('canvas').height = window.innerHeight * window.devicePixelRatio;
window.addEventListener('resize', softFullscreenResizeWebGLRenderTarget);

function setupFiles() {
  FS.createDataFile('/', 'input.txt',
    Module['intArrayFromString']('Input goes here.'), true,
    true);
  FS.createDataFile('/', 'output.txt',
    'Output can be placed here (-o output.txt)', true, true);
}

function printer(text) {
  text = Array.prototype.slice.call(arguments).join(' ');
  // These replacements are necessary if you render to raw HTML
  // text = text.replace(/&/g, "&amp;");
  // text = text.replace(/</g, "&lt;");
  // text = text.replace(/>/g, "&gt;");
  // text = text.replace('\n', '<br>', 'g');
  // console.log("OUTPUT", text);
  FS.writeFile('output.txt', text);
  console.log(text);
}
function printErr(text) {
  text = Array.prototype.slice.call(arguments).join(' ');
  if (0) {              // XXX disabled for safety typeof dump == 'function') {
    dump(text + '\n');  // fast, straight to the real console
  } else {
    console.error(text);
  }
}
function wrapFunctions() {
  mecab_do = Module.cwrap('mecab_do2', 'number', ['string']);
}

var canvas = document.getElementById("canvas");
var Module = {
  TOTAL_MEMORY: 2147483648,
  preRun : [setupFiles],
  postRun : [wrapFunctions],
  noExitRuntime : true,
  noInitialRun : false,
  print : printer,
  printErr : printErr,
  errorhandler: function(err, url) {
    // arguments: err, url, line. This function must return 'true' if the error is handled, otherwise 'false'
    console.error(err);
    return false;
  },
  canvas: canvas,
  dataUrl: "mecab.data",
  // codeUrl: "mecab.js",
  // memUrl: "Release/AngryBots.mem",
  compatibilitycheck: function() {
    if (typeof Wasm !== 'object') (alert("You need a browser which supports WebAssembly to run this content. See the WebAssembly demo page for instructions."), window.history.back());
    hasWebGL ? mobile ? confirm("Please note that Unity WebGL is not currently supported on mobiles. Press Ok if you wish to continue anyway.") || window.history.back() : -1 == browser.indexOf("Firefox") && -1 == browser.indexOf("Chrome") && -1 == browser.indexOf("Safari") && (confirm("Please note that your browser is not currently supported for this Unity WebGL content. Try installing Firefox, or press Ok if you wish to continue anyway.") || window.history.back()) : (alert("You need a browser which supports WebGL to run this content. Try installing Firefox."), window.history.back())
  },
  // preInit: function() {
  //   console.log('preInit');
  // },
  // preRun: function() {
  //   console.log('preRun');
  // },
  progress: (new UnityProgress(canvas)),
};

function lengthBytesUTF8(str) {
 var len = 0;
 for (var i = 0; i < str.length; ++i) {
  var u = str.charCodeAt(i);
  if (u >= 55296 && u <= 57343) u = 65536 + ((u & 1023) << 10) | str.charCodeAt(++i) & 1023;
  if (u <= 127) {
   ++len;
  } else if (u <= 2047) {
   len += 2;
  } else if (u <= 65535) {
   len += 3;
  } else if (u <= 2097151) {
   len += 4;
  } else if (u <= 67108863) {
   len += 5;
  } else {
   len += 6;
  }
 }
 return len;
}
Module["lengthBytesUTF8"] = lengthBytesUTF8;

function stringToUTF8Array(str, outU8Array, outIdx, maxBytesToWrite) {
 if (!(maxBytesToWrite > 0)) return 0;
 var startIdx = outIdx;
 var endIdx = outIdx + maxBytesToWrite - 1;
 for (var i = 0; i < str.length; ++i) {
  var u = str.charCodeAt(i);
  if (u >= 55296 && u <= 57343) u = 65536 + ((u & 1023) << 10) | str.charCodeAt(++i) & 1023;
  if (u <= 127) {
   if (outIdx >= endIdx) break;
   outU8Array[outIdx++] = u;
  } else if (u <= 2047) {
   if (outIdx + 1 >= endIdx) break;
   outU8Array[outIdx++] = 192 | u >> 6;
   outU8Array[outIdx++] = 128 | u & 63;
  } else if (u <= 65535) {
   if (outIdx + 2 >= endIdx) break;
   outU8Array[outIdx++] = 224 | u >> 12;
   outU8Array[outIdx++] = 128 | u >> 6 & 63;
   outU8Array[outIdx++] = 128 | u & 63;
  } else if (u <= 2097151) {
   if (outIdx + 3 >= endIdx) break;
   outU8Array[outIdx++] = 240 | u >> 18;
   outU8Array[outIdx++] = 128 | u >> 12 & 63;
   outU8Array[outIdx++] = 128 | u >> 6 & 63;
   outU8Array[outIdx++] = 128 | u & 63;
  } else if (u <= 67108863) {
   if (outIdx + 4 >= endIdx) break;
   outU8Array[outIdx++] = 248 | u >> 24;
   outU8Array[outIdx++] = 128 | u >> 18 & 63;
   outU8Array[outIdx++] = 128 | u >> 12 & 63;
   outU8Array[outIdx++] = 128 | u >> 6 & 63;
   outU8Array[outIdx++] = 128 | u & 63;
  } else {
   if (outIdx + 5 >= endIdx) break;
   outU8Array[outIdx++] = 252 | u >> 30;
   outU8Array[outIdx++] = 128 | u >> 24 & 63;
   outU8Array[outIdx++] = 128 | u >> 18 & 63;
   outU8Array[outIdx++] = 128 | u >> 12 & 63;
   outU8Array[outIdx++] = 128 | u >> 6 & 63;
   outU8Array[outIdx++] = 128 | u & 63;
  }
 }
 outU8Array[outIdx] = 0;
 return outIdx - startIdx;
}
Module["stringToUTF8Array"] = stringToUTF8Array;

function intArrayFromString(stringy, dontAddNull, length /* optional */) {
  var len = length > 0 ? length : lengthBytesUTF8(stringy)+1;
  var u8array = new Array(len);
  var numBytesWritten = stringToUTF8Array(stringy, u8array, 0, u8array.length);
  if (dontAddNull) u8array.length = numBytesWritten;
  return u8array;
}
Module["intArrayFromString"] = intArrayFromString;

var xhr = new XMLHttpRequest();
xhr.open('GET', 'mecab.wasm', true);
xhr.responseType = 'arraybuffer';
xhr.onload = function() {
  Module.wasmBinary = xhr.response;
  // console.log(Module);

  // var script = document.createElement('script');
  // script.src = "mecab.js";
  // script.onload = function() {
  //   console.log(FS);
  //   yo();
  // };
  // document.body.appendChild(script);

  var codeXHR = new XMLHttpRequest();
  codeXHR.open('GET', 'mecab.js', true);
  codeXHR.onload = function() {
    var code = codeXHR.responseText;
    var blob = new Blob([code], {type: 'text/javascript'});
    codeXHR = null;
    var src = URL.createObjectURL(blob);
    var script = document.createElement('script');
    script.src = URL.createObjectURL(blob);
    script.onload = function() {
      URL.revokeObjectURL(script.src);
      console.log(FS);
    };
    document.body.appendChild(script);
  }
  codeXHR.send(null);

};
xhr.send(null);

function yo() {
  setupFiles();
  var args = "";
  args += " -r mecabrc -d ipadic/ -o output.txt input.txt";

  var command = 'mecab ' + args;


  var text = "ようこそ";
  FS.writeFile('input.txt', text);
  FS.writeFile('output.txt', "");

  mecab_do(args);

  var output = FS.readFile('output.txt', {encoding : "utf8"});

  console.log(output);
// var newlines = (output.match(/\n/g) || []).length + 1;
// var newblock = d3.select('#mecab-output')
//     .insert('div', ":first-child")
//     .classed('mecab-output-block', true);
// newblock.append('h1').text('Result');
// newblock.append('p').html("Equivalent command: <tt>" + command + "</tt>");
// newblock.append('textarea')
//     .text(output)
//     .style({height : (1.35*newlines)+"em"});
}

</script>


</body>
</html>
