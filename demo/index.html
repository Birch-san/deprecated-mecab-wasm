<!doctype html>
<html lang="en-us">
<head>
    <!--
    Copied from https://webassembly.github.io/demo/AngryBots/
  -->
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>MeCab WebAssembly</title>
  <style type="text/css">
  label {
    display:block;
    font-weight: 700;
  }
  /*.hide-until-load {
    display:none;
  }*/
  #input {
    width: 80%;
    height: 200px;
    font-size: 1.2em;
  }
  #args {
    width: 80%;
    height: 1.2em;
    font-size: 1.2em;
    font-family:monospace;
  }
  #submit {
    display: inline-block;
  }
  #output {
    width: 80%;
    height: 200px;
    font-family:monospace;
    /*font-size: 1.2em;*/
    /*resize: both;*/
  }
  </style>
</head>
<body>

<div class="hide-until-load">
  <div>
    <label>Input</label>
    <textarea id="input">今日は、世界。</textarea>
    <input type="button" value="Tokenize" id="submit">
  </div>
  <div>
    <label>Command-line args</label>
    <textarea id="args"></textarea>
    <p id="examples-toggle">See example args</p>
    <dl id="example-arguments" hidden>
      <dt><tt>-O yomi</tt></dt>
      <dd>Convert to onyomi</dd>
      <dt><tt>-O wakati</tt></dt>
      <dd>Put spaces between words</dd>
      <dt><tt>-O chasen</tt></dt>
      <dd>See full decomposition</dd>
      <dt><tt>--node-format=%m[%f[7]] --eos-format=\n --unk-format=%m[]</tt></dt>
      <dd><a href="https://ankiweb.net/shared/info/3918629684">Anki Japanese Support</a> formatting</dd>
      <dt>Note to experienced users</dt>
      <dd><tt>-r mecabrc -d ipadic/</tt> flags will be automatically added. The results are based on the IPADIC dictionary.
      </dd>
    </dl>
  </div>
  <div>
    <label>Output</label>
    <textarea readonly id="output"></textarea>
  </div>
</div>

<div class="loader">
  <label>Number of Dependencies in-flight:</label>
  <input type="number" readonly id="deps">
</div>
<div class="loader">
  <label>Percent loaded:</label>
  <input type="text" readonly id="percent">
</div>
<div class="loader">
  <label>Bytes loaded:</label>
  <input type="number" readonly id="numerator">
</div>
<div class="loader">
  <label>Bytes outstanding:</label>
  <input type="number" readonly id="denominator">
</div>

  <script type='text/javascript'>

var waiting = [];

function updateProgress() {
  // console.log(JSON.stringify(waiting, null, "  "));
  var defined = waiting.filter(function(entry) {
    return entry.total !== undefined && entry.loaded !== undefined;
  });
  // console.log(defined);

  function sum(a, b) {
    return a + b;
  };

  var numerator = defined
  .map(function(iterand) {
    return iterand.loaded;
  })
  .reduce(sum, 0);

  var denominator = defined
  .map(function(iterand) {
    return iterand.total;
  })
  .reduce(sum, 0);

  var progress = numerator/denominator;

  // console.log(numerator, denominator, waiting.length, progress);
  document.getElementById("deps").value = waiting.length;
  document.getElementById("numerator").value = numerator;
  document.getElementById("denominator").value = denominator;
  document.getElementById("percent").value = (isNaN(progress) ? "?" : Math.floor(progress*100))+"%";

}

/**
From Andrew Newdigate, http://stackoverflow.com/a/10796951/5257399
*/
(function(XHR) {
  "use strict";

  var open = XHR.prototype.open;
  var send = XHR.prototype.send;

  // XHR.prototype.onload

  XHR.prototype.open = function(method, url, async, user, pass) {
      this._url = url;

      var progObject = {
        loaded: 0,
        total: undefined
      };

      waiting.push(progObject);

      function removeFromWaiting(ref) {
        var index = waiting.indexOf(ref);
        if(index !== -1) {
          waiting.splice(index, 1);
        }
      }

      this.onprogress = function(event) {
        // if (event.loaded === ) {
        //   removeFromWaiting(this);
        // }
        if (event.lengthComputable) {
          // console.log(event.loaded, event.total);
          progObject.loaded = event.loaded;
          progObject.total = event.total;
          updateProgress();
        }
      };

      this.onloadend = function(event) {
        // console.log(event);
        removeFromWaiting(progObject);
        updateProgress();
      };

      open.call(this, method, url, async, user, pass);
  };

  XHR.prototype.send = function(data) {
      var self = this;
      var oldOnReadyStateChange;
      var url = this._url;

      function onReadyStateChange() {
          if(self.readyState == 4 /* complete */) {
              /* This is where you can put code that you want to execute post-complete*/
              /* URL is kept in this._url */
          }

          if(oldOnReadyStateChange) {
              oldOnReadyStateChange();
          }
      }

      /* Set xhr.noIntercept to true to disable the interceptor for a particular call */
      if(!this.noIntercept) {            
          if(this.addEventListener) {
              this.addEventListener("readystatechange", onReadyStateChange, false);
          } else {
              oldOnReadyStateChange = this.onreadystatechange; 
              this.onreadystatechange = onReadyStateChange;
          }
      }

      send.call(this, data);
  }
})(XMLHttpRequest);

function setupFiles() {
  FS.createDataFile('/', 'input.txt',
    Module['intArrayFromString']('Input goes here.'), true,
    true);
  FS.createDataFile('/', 'output.txt',
    'Output can be placed here (-o output.txt)', true, true);
}

function printer(text) {
  text = Array.prototype.slice.call(arguments).join(' ');
  // These replacements are necessary if you render to raw HTML
  // text = text.replace(/&/g, "&amp;");
  // text = text.replace(/</g, "&lt;");
  // text = text.replace(/>/g, "&gt;");
  // text = text.replace('\n', '<br>', 'g');
  // console.log("OUTPUT", text);
  FS.writeFile('output.txt', text);
  console.log(text);
}
function printErr(text) {
  text = Array.prototype.slice.call(arguments).join(' ');
  if (0) {              // XXX disabled for safety typeof dump == 'function') {
    dump(text + '\n');  // fast, straight to the real console
  } else {
    console.error(text);
  }
}
var mecab_do;
function wrapFunctions() {
  mecab_do = Module.cwrap('mecab_do2', 'number', ['string']);
}

function begin() {
  wrapFunctions();

  [].forEach.call(document.getElementsByClassName("loader"),
    function (el) {
      el.style.display = "none";
    });

  [].forEach.call(document.getElementsByClassName("hide-until-load"),
    function (el) {
      el.className = "";
    });

  yo();
}

var canvas = document.getElementById("canvas");
var Module = {
  TOTAL_MEMORY: 134217728,
  preRun : [setupFiles],
  postRun : [begin],
  noExitRuntime : true,
  noInitialRun : false,
  print : printer,
  printErr : printErr,
  errorhandler: function(err, url) {
    // arguments: err, url, line. This function must return 'true' if the error is handled, otherwise 'false'
    console.error(err);
    return false;
  },
  // canvas: canvas,
  dataUrl: "mecab.data",
  // codeUrl: "mecab.js",
  memUrl: "mecab.html.mem",
  compatibilitycheck: function() {
    if (typeof Wasm !== 'object') (alert("You need a browser which supports WebAssembly to run this content. See the WebAssembly demo page for instructions."), window.history.back());
    hasWebGL ? mobile ? confirm("Please note that Unity WebGL is not currently supported on mobiles. Press Ok if you wish to continue anyway.") || window.history.back() : -1 == browser.indexOf("Firefox") && -1 == browser.indexOf("Chrome") && -1 == browser.indexOf("Safari") && (confirm("Please note that your browser is not currently supported for this Unity WebGL content. Try installing Firefox, or press Ok if you wish to continue anyway.") || window.history.back()) : (alert("You need a browser which supports WebGL to run this content. Try installing Firefox."), window.history.back())
  },
};

var xhr = new XMLHttpRequest();
xhr.open('GET', 'mecab.wasm', true);
xhr.responseType = 'arraybuffer';
xhr.onload = function() {
  Module.wasmBinary = xhr.response;

  var codeXHR = new XMLHttpRequest();
  codeXHR.open('GET', 'mecab.min.js', true);
  codeXHR.onload = function() {
    var code = codeXHR.responseText;
    var blob = new Blob([code], {type: 'text/javascript'});
    codeXHR = null;
    var src = URL.createObjectURL(blob);
    var script = document.createElement('script');
    script.src = URL.createObjectURL(blob);
    script.onload = function() {
      URL.revokeObjectURL(script.src);
      // console.log(FS);
    };
    document.body.appendChild(script);
  }
  codeXHR.send(null);

};
xhr.send(null);

function yo() {
  // console.log('sup')
  var args = "";
  args += " -r mecabrc -d ipadic/ -o output.txt input.txt";

  var command = 'mecab ' + args;


  var text = "今日は世界";
  if (text.slice(-1) != "\n") {
    text += '\n';
  }
  FS.writeFile('input.txt', text);
  FS.writeFile('output.txt', "");

  mecab_do(args);

  var output = FS.readFile('output.txt', {encoding : "utf8"});
  output = output.replace(/EOS\s*$/g, "");

  // console.log(output);
// var newlines = (output.match(/\n/g) || []).length + 1;
document.getElementById("output").value = output;
// var newblock = d3.select('#mecab-output')
//     .insert('div', ":first-child")
//     .classed('mecab-output-block', true);
// newblock.append('h1').text('Result');
// newblock.append('p').html("Equivalent command: <tt>" + command + "</tt>");
// newblock.append('textarea')
//     .text(output)
//     .style({height : (1.35*newlines)+"em"});
}

</script>


</body>
</html>
